name: ğŸš€ CI Pipeline

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

env:
  NODE_VERSION: '20'
  NX_CLOUD_DISTRIBUTED_EXECUTION: false

permissions:
  actions: read
  contents: read
  pull-requests: write
  id-token: write

jobs:
  setup:
    name: ğŸ“¦ Setup & Install
    runs-on: ubuntu-latest
    outputs:
      cache-key: ${{ steps.cache-deps.outputs.cache-hit }}
    steps:
      - name: ğŸ“¥ Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: ğŸŸ¢ Setup Node.js & Cache
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: npm

      - name: ğŸ“¦ Install dependencies
        run: npm ci

      - name: ğŸ’¾ Cache node_modules
        uses: actions/cache/save@v4
        id: cache-deps
        with:
          path: node_modules
          key: deps-${{ runner.os }}-${{ hashFiles('package-lock.json') }}

  build-test:
    name: ğŸ—ï¸ Build & Test
    runs-on: ubuntu-latest
    needs: setup
    env:
      DATABASE_URL: ${{ github.event_name == 'pull_request' && secrets.DEV_DATABASE_URL || secrets.PROD_DATABASE_URL }}
      NEXT_PUBLIC_CLERK_PUBLISHABLE_KEY: ${{ secrets.NEXT_PUBLIC_CLERK_PUBLISHABLE_KEY }}
    steps:
      - name: ğŸ“¥ Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: ğŸŸ¢ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}

      - name: ğŸ”„ Restore dependencies
        uses: actions/cache/restore@v4
        with:
          path: node_modules
          key: deps-${{ runner.os }}-${{ hashFiles('package-lock.json') }}
          fail-on-cache-miss: true

      - name: ğŸ§ª Test & TypeCheck
        run: npx nx run-many -t test typecheck

      - name: ğŸ—„ï¸ Database migrations
        run: npm run db:migrate:prod

      - name: ğŸ”¨ Build all projects
        run: SKIP_ENV_VALIDATION=1 npx nx run-many --target=build --all

  quality-security:
    name: ğŸ” Quality & Security
    runs-on: ubuntu-latest
    needs: setup
    steps:
      - name: ğŸ“¥ Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: ğŸŸ¢ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}

      - name: ğŸ”„ Restore dependencies
        uses: actions/cache/restore@v4
        with:
          path: node_modules
          key: deps-${{ runner.os }}-${{ hashFiles('package-lock.json') }}
          fail-on-cache-miss: true

      - name: ğŸ§¹ Lint & fix
        run: npm run lint:fix

      - name: ğŸ›¡ï¸ Security audit
        run: npm audit --audit-level=high

  ai-review:
    name: ğŸ¤– Claude Review (Advisory)
    runs-on: ubuntu-latest
    if: github.event_name == 'pull_request'
    continue-on-error: true
    steps:
      - name: ğŸ“¥ Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: ğŸ¤– AI Code Review
        uses: anthropics/claude-code-action@beta
        with:
          anthropic_api_key: ${{ secrets.ANTHROPIC_API_KEY }}
          direct_prompt: |
            Review this PR for bugs and security issues. Focus on:
            â€¢ Security vulnerabilities
            â€¢ Logic errors & edge cases  
            â€¢ Resource leaks & performance
            â€¢ TypeScript/type safety

            Be concise. Report only actual issues found.
            If clean, state: "No security issues or bugs detected."

  status:
    name: âœ… CI Status
    runs-on: ubuntu-latest
    needs: [setup, build-test, quality-security]
    if: always()
    steps:
      - name: ğŸ“Š Check Results
        run: |
          # Required jobs that must pass
          REQUIRED_JOBS=("setup" "build-test" "quality-security")

          echo "ğŸ“‹ CI Results Summary:"
          echo "Setup: ${{ needs.setup.result }}"
          echo "Build & Test: ${{ needs.build-test.result }}"
          echo "Quality & Security: ${{ needs.quality-security.result }}"
          echo ""

          # Check required jobs
          for job in "${REQUIRED_JOBS[@]}"; do
            case $job in
              "setup")
                if [[ "${{ needs.setup.result }}" != "success" ]]; then
                  echo "âŒ Setup failed - dependency installation issues"
                  exit 1
                fi
                ;;
              "build-test")
                if [[ "${{ needs.build-test.result }}" != "success" ]]; then
                  echo "âŒ Build/Test failed - code doesn't compile or tests failing"
                  exit 1
                fi
                ;;
              "quality-security")
                if [[ "${{ needs.quality-security.result }}" != "success" ]]; then
                  echo "âŒ Quality/Security failed - fix linting and security issues"
                  exit 1
                fi
                ;;
            esac
          done

          echo "ğŸ‰ All quality gates passed! Ready to merge."