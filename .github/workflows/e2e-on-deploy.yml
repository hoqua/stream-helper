name: ğŸ­ E2E Tests on Deploy

on:
  deployment_status:

jobs:
  check-deployments:
    name: ğŸ” Check Both Deployments
    runs-on: ubuntu-latest
    if: github.event.deployment_status.state == 'success'
    outputs:
      run-e2e: ${{ steps.check-deployments.outputs.run-e2e }}
      vercel-url: ${{ steps.check-deployments.outputs.vercel-url }}
    steps:
      - name: ğŸ“‹ Log Current Deployment
        run: |
          echo "=========================================="
          echo "ğŸš€ NEW DEPLOYMENT SUCCESS"
          echo "=========================================="
          echo "Environment: ${{ github.event.deployment.environment }}"
          echo "URL: ${{ github.event.deployment_status.environment_url }}"
          echo "SHA: ${{ github.event.deployment.sha }}"
          echo "Creator: ${{ github.event.deployment.creator.login }}"
          echo "=========================================="

      - name: ğŸ” Check Both Deployments
        id: check-deployments
        uses: actions/github-script@v7
        with:
          script: |
            const sha = '${{ github.event.deployment.sha }}';
            console.log(`\nğŸ” Checking deployments for SHA: ${sha}\n`);
            
            // Get all deployments for this SHA
            const { data: deployments } = await github.rest.repos.listDeployments({
              owner: context.repo.owner,
              repo: context.repo.repo,
              sha: sha
            });
            
            let vercelUrl = null;
            let hasRailway = false;
            
            // Check each deployment's status
            for (const dep of deployments) {
              const { data: statuses } = await github.rest.repos.listDeploymentStatuses({
                owner: context.repo.owner,
                repo: context.repo.repo,
                deployment_id: dep.id
              });
              
              const latestStatus = statuses[0];
              if (!latestStatus || latestStatus.state !== 'success') {
                continue;
              }
              
              const url = latestStatus.environment_url || '';
              const creator = dep.creator.login;
              
              // Detect platforms
              if (url.includes('vercel.app') || creator === 'vercel[bot]') {
                vercelUrl = url;
                console.log(`âœ… Vercel deployed: ${url}`);
              } else if (url.includes('railway.app') || creator === 'railway-app[bot]') {
                hasRailway = true;
                console.log(`âœ… Railway deployed: ${url}`);
              }
            }
            
            if (vercelUrl && hasRailway) {
              console.log('ğŸ‰ BOTH DEPLOYMENTS READY - RUNNING E2E TESTS!');
              core.setOutput('run-e2e', 'true');
              core.setOutput('vercel-url', vercelUrl);
            } else {
              console.log('â³ Waiting for both deployments...');
              console.log(`Vercel: ${vercelUrl ? 'âœ…' : 'âŒ'}`);
              console.log(`Railway: ${hasRailway ? 'âœ…' : 'âŒ'}`);
              core.setOutput('run-e2e', 'false');
            }

  setup-e2e:
    name: ğŸ“¦ Setup E2E Environment
    runs-on: ubuntu-latest
    needs: check-deployments
    if: needs.check-deployments.outputs.run-e2e == 'true'
    outputs:
      cache-key: ${{ steps.cache-deps.outputs.cache-hit }}
      playwright-cache-key: ${{ steps.cache-playwright.outputs.cache-hit }}
    steps:
      - name: ğŸ“¥ Checkout Code
        uses: actions/checkout@v4
        with:
          ref: ${{ github.event.deployment.sha }}

      - name: ğŸŸ¢ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: npm

      - name: ğŸ’¾ Restore node_modules Cache
        id: cache-deps
        uses: actions/cache@v4
        with:
          path: node_modules
          key: deps-${{ runner.os }}-${{ hashFiles('package-lock.json') }}
          restore-keys: |
            deps-${{ runner.os }}-

      - name: ğŸ“¦ Install Dependencies
        if: steps.cache-deps.outputs.cache-hit != 'true'
        run: npm ci

      - name: ğŸ’¾ Cache node_modules for Test Job
        if: steps.cache-deps.outputs.cache-hit != 'true'
        uses: actions/cache/save@v4
        with:
          path: node_modules
          key: deps-${{ runner.os }}-${{ hashFiles('package-lock.json') }}

      - name: ğŸ’¾ Restore Playwright Cache
        id: cache-playwright
        uses: actions/cache@v4
        with:
          path: ~/.cache/ms-playwright
          key: playwright-${{ runner.os }}-${{ hashFiles('apps/web-e2e/playwright.config.ts') }}
          restore-keys: |
            playwright-${{ runner.os }}-

      - name: ğŸ­ Install Playwright
        if: steps.cache-playwright.outputs.cache-hit != 'true'
        run: npx playwright install chromium

      - name: ğŸ’¾ Cache Playwright for Test Job
        if: steps.cache-playwright.outputs.cache-hit != 'true'
        uses: actions/cache/save@v4
        with:
          path: ~/.cache/ms-playwright
          key: playwright-${{ runner.os }}-${{ hashFiles('apps/web-e2e/playwright.config.ts') }}

  run-e2e-tests:
    name: ğŸ§ª Run E2E Tests
    runs-on: ubuntu-latest
    needs: [check-deployments, setup-e2e]
    if: needs.check-deployments.outputs.run-e2e == 'true'
    steps:
      - name: ğŸ“¥ Checkout Code
        uses: actions/checkout@v4
        with:
          ref: ${{ github.event.deployment.sha }}

      - name: ğŸŸ¢ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: ğŸ’¾ Restore node_modules Cache
        id: restore-deps
        uses: actions/cache/restore@v4
        with:
          path: node_modules
          key: deps-${{ runner.os }}-${{ hashFiles('package-lock.json') }}
          restore-keys: |
            deps-${{ runner.os }}-

      - name: ğŸ“¦ Fallback Install Dependencies
        if: steps.restore-deps.outputs.cache-hit != 'true'
        run: npm ci

      - name: ğŸ’¾ Restore Playwright Cache
        id: restore-playwright
        uses: actions/cache/restore@v4
        with:
          path: ~/.cache/ms-playwright
          key: playwright-${{ runner.os }}-${{ hashFiles('apps/web-e2e/playwright.config.ts') }}
          restore-keys: |
            playwright-${{ runner.os }}-

      - name: ğŸ­ Fallback Install Playwright
        if: steps.restore-playwright.outputs.cache-hit != 'true'
        run: npx playwright install chromium

      - name: ğŸ§ª Run E2E Tests
        run: |
          echo "=========================================="
          echo "ğŸ¯ RUNNING E2E TESTS"
          echo "=========================================="
          echo "Vercel URL: ${{ needs.check-deployments.outputs.vercel-url }}"
          echo "=========================================="
          
          npx nx e2e web-e2e
        env:
          VERCEL_URL: ${{ needs.check-deployments.outputs.vercel-url }}
          DATABASE_URL: ${{ secrets.DEV_DATABASE_URL }}
          CI: true

      - name: ğŸ“Š Upload Test Results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: e2e-results-${{ github.event.deployment.sha }}
          path: |
            apps/web-e2e/playwright-report/
            apps/web-e2e/test-results/
          retention-days: 30

  comment-pr:
    name: ğŸ’¬ Comment on PR
    runs-on: ubuntu-latest
    needs: [check-deployments, run-e2e-tests]
    if: always() && needs.check-deployments.outputs.run-e2e == 'true'
    steps:
      - name: ğŸ’¬ Comment on PR
        uses: actions/github-script@v7
        with:
          script: |
            // Find PR for this SHA
            const sha = '${{ github.event.deployment.sha }}';
            const { data: prs } = await github.rest.pulls.list({
              owner: context.repo.owner,
              repo: context.repo.repo,
              state: 'open'
            });
            
            const pr = prs.find(p => p.head.sha === sha);
            if (!pr) {
              console.log('No PR found for this SHA');
              return;
            }
            
            const success = '${{ needs.run-e2e-tests.result }}' === 'success';
            const icon = success ? 'âœ…' : 'âŒ';
            const status = success ? 'PASSED' : 'FAILED';
            
            const comment = `## ${icon} E2E Tests ${status}
            
            **Vercel:** ${{ needs.check-deployments.outputs.vercel-url }}
            **Railway:** Deployed âœ…
            
            ${success 
              ? 'ğŸ‰ All E2E tests passed against the deployed stack!' 
              : 'âš ï¸ Some tests failed. Check the [workflow run](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}) for details.'}`;
            
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: pr.number,
              body: comment
            });